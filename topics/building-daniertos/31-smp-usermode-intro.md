# é›™é‡èº«ä»½ï¼šç•¶ SMP é‡ä¸Š User Mode

**ä½œè€…**: Danny Jiang
**æ—¥æœŸ**: 2025-12-26

---

## å‰è¨€ï¼šè‡¥åº•è­¦å¯Ÿçš„é›™é‡äººç”Ÿ

æƒ³åƒä½ æ˜¯ä¸€åè‡¥åº•è­¦å¯Ÿã€‚

ç™½å¤©ï¼Œä½ ç©¿è‘—ä¾¿æœæ··åœ¨è¡—é ­ï¼Œè·Ÿå°æ··æ··å€‘ç¨±å…„é“å¼Ÿã€‚ä½ çš„èº«ä»½è­‰ã€é§•ç…§ã€éŠ€è¡Œå¸³æˆ¶éƒ½æ˜¯å‡çš„ã€‚åœ¨é€™å€‹ä¸–ç•Œè£¡ï¼Œä½ æ˜¯ã€Œé˜¿æ˜ã€ï¼Œä¸€å€‹é æ‰“é›¶å·¥ç¶­ç”Ÿçš„è¡—é ­æ··æ··ã€‚

ä½†ç•¶ä½ çš„è­¦ç”¨æ‰‹æ©ŸéŸ¿èµ·ï¼Œä½ å¾—è¿…é€Ÿåˆ‡æ›èº«ä»½ã€‚ä½ å›åˆ°ç§˜å¯†æ“šé»ï¼Œæ›ä¸Šè­¦æœï¼Œèª¿å‡ºè³‡æ–™åº«ï¼Œå½™å ±æƒ…å ±ã€‚åœ¨é€™å€‹ä¸–ç•Œè£¡ï¼Œä½ æ˜¯ã€Œè­¦å“¡ 0037ã€ï¼Œæœ‰æ¬Šé™å­˜å–æ©Ÿå¯†è³‡æ–™ã€èª¿å‹•è³‡æºã€ç™¼è™Ÿæ–½ä»¤ã€‚

**é€™å…©å€‹èº«ä»½ä¸èƒ½æ··æ·†ã€‚**

å¦‚æœä½ åœ¨è¡—é ­æ™‚æ„å¤–æš´éœ²äº†è­¦å¯Ÿèº«ä»½ï¼Œä»»å‹™å¤±æ•—ã€‚å¦‚æœä½ åœ¨è­¦å±€æ™‚å¿˜è¨˜è‡ªå·±æ˜¯å“ªå€‹è‡¥åº•ï¼Œç³»çµ±æ··äº‚ã€‚

é€™æ­£æ˜¯ danieRTOS v3.x é¢è‡¨çš„æŒ‘æˆ°ï¼š**ä¸€å€‹ RTOS åŒæ™‚æ‰®æ¼”å…©å€‹è§’è‰²**ã€‚

---

## ä¸€ã€æ—…ç¨‹å›é¡§ï¼šæˆ‘å€‘èµ°éçš„è·¯

åœ¨æ·±å…¥ v3.x ä¹‹å‰ï¼Œè®“æˆ‘å€‘å›é¡§ä¸€ä¸‹ danieRTOS çš„æ¼”é€²ï¼š

| ç‰ˆæœ¬ | åˆ¥å | æ ¸å¿ƒç‰¹æ€§ | æ ¸å¿ƒæŒ‘æˆ° |
|------|------|----------|----------|
| **v0.x** | Nano | å–®æ ¸å¿ƒ M-mode | åŸºç¤ä»»å‹™èª¿åº¦ã€Context Switch |
| **v1.x** | Secure | å–®æ ¸å¿ƒ M+U mode | ç‰¹æ¬Šç´šåˆ‡æ›ã€PMP è¨˜æ†¶é«”ä¿è­· |
| **v2.x** | MSMP | å¤šæ ¸å¿ƒ M-mode | ç«¶çˆ­æ¢ä»¶ã€Cache Coherencyã€IPI |
| **v3.x** | SMP | å¤šæ ¸å¿ƒ M+U mode | **æ•´åˆä»¥ä¸Šæ‰€æœ‰æŒ‘æˆ°** |

æ¯å€‹ç‰ˆæœ¬éƒ½æœ‰å…¶ç¨ç‰¹çš„ã€Œè…¦è¿´è·¯ã€ï¼š

- **v0.x æ€ç¶­**ï¼šã€Œå¦‚ä½•åœ¨å–®ä¸€ CPU ä¸Šè®“å¤šå€‹ Task è¼ªæµåŸ·è¡Œï¼Ÿã€
- **v1.x æ€ç¶­**ï¼šã€Œå¦‚ä½•å®‰å…¨åœ°å¾ M-mode è·³åˆ° U-modeï¼Œç„¶å¾Œæ­£ç¢ºè¿”å›ï¼Ÿã€
- **v2.x æ€ç¶­**ï¼šã€Œå¦‚ä½•è®“å¤šå€‹æ ¸å¿ƒå®‰å…¨åœ°å…±äº«è³‡æºï¼Ÿã€

**v3.x çš„æŒ‘æˆ°**ï¼šæŠŠ v1.x å’Œ v2.x çš„ç¨‹å¼ç¢¼åˆä½µã€‚è½èµ·ä¾†åªæ˜¯ `git merge`ï¼Œå°å§ï¼Ÿ

**éŒ¯ã€‚å¤§éŒ¯ç‰¹éŒ¯ã€‚**

---

## äºŒã€æ ¸å¿ƒè¡çªï¼šã€Œæˆ‘æ˜¯èª°ï¼Ÿã€çš„èº«ä»½å±æ©Ÿ

ç•¶æˆ‘é–‹å§‹æ•´åˆ v1.x å’Œ v2.x ç¨‹å¼ç¢¼æ™‚ï¼Œç¬¬ä¸€å€‹æ’ç‰†çš„å•é¡Œæ˜¯ï¼š**tp æš«å­˜å™¨çš„é›™é‡è§’è‰²è¡çª**ã€‚

é€™å°±åƒè‡¥åº•è­¦å¯Ÿçš„èº«ä»½è­‰æ˜å•é¡Œï¼šåœ¨è¡—é ­ï¼Œä½ çš„ã€Œèº«ä»½è­‰ã€æ˜¯å‡çš„ï¼›åœ¨è­¦å±€ï¼Œä½ çš„ã€Œè­¦è­‰ã€æ‰æ˜¯çœŸçš„ã€‚ä½†ç•¶ä½ çªç„¶æ¥åˆ°é›»è©±ï¼ˆtrapï¼‰ï¼Œä½ æ€éº¼è­‰æ˜è‡ªå·±æ˜¯èª°ï¼Ÿ

### 2.1 v1.x çš„è¨­è¨ˆï¼šUser å„ªå…ˆ

åœ¨ v1.x å–®æ ¸å¿ƒ + User Mode ç³»çµ±ä¸­ï¼Œä¸–ç•Œå¾ˆå–®ç´”ï¼š

- **tp** (Thread Pointer) å±¬æ–¼ User ç¨‹å¼ï¼Œç”¨æ–¼ Thread Local Storage (TLS)
- **mscratch** å­˜æ”¾ Kernel Stack Pointerï¼Œç”¨æ–¼ Trap æ™‚åˆ‡æ›å †ç–Š

```c
// v1.x: Trap Entry
csrrw sp, mscratch, sp    // äº¤æ› sp å’Œ mscratch
// ç¾åœ¨ sp = kernel_sp, mscratch = user_sp
// å¯ä»¥å®‰å…¨åœ°ä¿å­˜æš«å­˜å™¨åˆ° kernel stack
```

**é‚è¼¯å¾ˆç°¡å–®**ï¼šåªæœ‰ä¸€å€‹æ ¸å¿ƒï¼Œä¸éœ€è¦çŸ¥é“ã€Œæˆ‘åœ¨å“ªå€‹æ ¸å¿ƒä¸Šã€ã€‚

### 2.2 v2.x çš„è¨­è¨ˆï¼šKernel å„ªå…ˆ

åœ¨ v2.x SMP ç³»çµ±ä¸­ï¼Œä¸–ç•Œè®Šå¾—è¤‡é›œï¼š

- **tp** æ°¸é æŒ‡å‘ç•¶å‰æ ¸å¿ƒçš„ `cpu_t` çµæ§‹
- Kernel çš„æ¯ä¸€è¡Œç¨‹å¼ç¢¼éƒ½å¯èƒ½éœ€è¦çŸ¥é“ã€Œæˆ‘åœ¨å“ªå€‹æ ¸å¿ƒä¸Šã€

```c
// v2.x: ä»»ä½•æ™‚å€™å–å¾— per-core è³‡æ–™
static inline cpu_t *smp_get_cpu(void) {
    cpu_t *cpu;
    asm volatile("mv %0, tp" : "=r"(cpu));
    return cpu;
}

// ä½¿ç”¨ç¯„ä¾‹
task_t *current = smp_get_cpu()->current_task;
```

**é‚è¼¯ä¹Ÿå¾ˆç°¡å–®**ï¼šæ²’æœ‰ User Modeï¼Œtp æ°¸é æ­¸ Kernel æ‰€æœ‰ã€‚

### 2.3 è¡çªçš„æœ¬è³ªï¼šç•¶å…©å€‹ä¸–ç•Œç¢°æ’

ç¾åœ¨æƒ³åƒ v3.xï¼šä¸€å€‹ User Mode Task åœ¨ Core 1 ä¸ŠåŸ·è¡Œï¼Œçªç„¶ç™¼ç”Ÿ Timer Interruptã€‚

**Trap Entry é‚£ä¸€åˆ»çš„ç‹€æ…‹**ï¼š

| æš«å­˜å™¨ | å€¼ | å•é¡Œ |
|--------|-----|------|
| tp | User TLS (å¯èƒ½æ˜¯ 0) | âŒ ä¸æ˜¯ cpu_tï¼ |
| sp | User Stack | âŒ ä¸èƒ½ç”¨ä¾†ä¿å­˜æš«å­˜å™¨ï¼ |
| mscratch | ??? | è©²æ”¾ä»€éº¼ï¼Ÿ |

**é€™æ˜¯ä¸€å€‹ã€Œé›ç”Ÿè›‹ã€å•é¡Œ**ï¼š

1. è¦çŸ¥é“ Kernel Stack åœ¨å“ª â†’ éœ€è¦å­˜å– `cpu->current_task->kstack`
2. è¦å­˜å– `cpu` â†’ éœ€è¦çŸ¥é“ tp
3. ä½† tp ç¾åœ¨æ˜¯ User çš„å€¼ â†’ **æ­»çµï¼**

å¦‚æœæˆ‘å€‘ä¸è§£æ±ºé€™å€‹å•é¡Œï¼ŒKernel é€£ã€Œè‡ªå·±åœ¨å“ªå€‹æ ¸å¿ƒä¸Šã€éƒ½ä¸çŸ¥é“ï¼Œæ›´åˆ¥èªªè™•ç†ä¸­æ–·äº†ã€‚

---

## ä¸‰ã€è§£æ±ºæ–¹æ¡ˆï¼šmscratch ä½œç‚ºä¸–ç•Œçš„æ©‹æ¨‘

å›åˆ°è‡¥åº•è­¦å¯Ÿçš„æ¯”å–»ï¼šä½ éœ€è¦ä¸€å€‹ã€Œç§˜å¯†è¯çµ¡äººã€ï¼Œéš¨æ™‚èƒ½å¹«ä½ åˆ‡æ›èº«ä»½ã€‚

åœ¨ RISC-V ä¸­ï¼Œé€™å€‹ã€Œç§˜å¯†è¯çµ¡äººã€å°±æ˜¯ **mscratch æš«å­˜å™¨**ã€‚

### 3.1 æ ¸å¿ƒè¨­è¨ˆï¼šSwap & Restore

è§£æ±ºé€™å€‹è¡çªçš„é—œéµæ˜¯ï¼š**è®“ mscratch åœ¨ User Mode æ™‚æŒ‡å‘ cpu_t**ã€‚

ç•¶ Trap ç™¼ç”Ÿæ™‚ï¼Œåªéœ€è¦ä¸€æ¢æŒ‡ä»¤å°±èƒ½å®Œæˆã€Œèº«ä»½åˆ‡æ›ã€ï¼š

```asm
csrrw tp, mscratch, tp
# é€™æ¢æŒ‡ä»¤åŒæ™‚åšäº†ï¼š
#   1. è®€å– mscratch åˆ° tp (tp = &cpu_t)
#   2. å°‡èˆŠçš„ tp å¯«å…¥ mscratch (mscratch = user_tp)
```

**å°±åƒè‡¥åº•æ¥åˆ°é›»è©±å¾Œï¼Œç¬é–“å¾ã€Œé˜¿æ˜ã€è®Šæˆã€Œè­¦å“¡ 0037ã€**ã€‚

### 3.2 ç‹€æ…‹è½‰æ›è¡¨

é€™æ˜¯ v3.x ä¸­ tp/mscratch çš„ç‹€æ…‹è½‰æ›ï¼š

| ç‹€æ…‹ | tp | mscratch | sp | èªªæ˜ |
|------|-----|----------|-----|------|
| **User Mode åŸ·è¡Œä¸­** | User TLS | â†’ `&cpu_t` | User Stack | User æ­£åœ¨åŸ·è¡Œ |
| **Trap Entry å¾Œ** | â†’ `&cpu_t` | User TLS | Kernel Stack | Kernel æ¥ç®¡ |
| **Kernel Mode åŸ·è¡Œä¸­** | â†’ `&cpu_t` | User TLS | Kernel Stack | Kernel è™•ç†ä¸­ |
| **mret è¿”å›å‰** | User TLS | â†’ `&cpu_t` | User Stack | æº–å‚™è¿”å› User |

**é—œéµæ´å¯Ÿ**ï¼šmscratch å’Œ tp å°±åƒä¸€å°ã€Œè¹ºè¹ºæ¿ã€ï¼Œç•¶ User åŸ·è¡Œæ™‚ï¼Œcpu_t è—åœ¨ mscratchï¼›ç•¶ Kernel åŸ·è¡Œæ™‚ï¼Œcpu_t åœ¨ tp ä¸­ã€‚

### 3.3 cpu_t çµæ§‹è¨­è¨ˆ

ç‚ºäº†è®“é€™å€‹æ©Ÿåˆ¶é‹ä½œï¼Œcpu_t çš„å‰å¹¾å€‹æ¬„ä½å¿…é ˆç²¾å¿ƒè¨­è¨ˆï¼š

```c
typedef struct cpu {
    /* â”€â”€â”€ Trap Scratch Area (offsets used in assembly) â”€â”€â”€ */
    uint64_t kernel_trap_sp; /* +0:  ç•¶å‰ Task çš„ Kernel Stack Top */
    uint64_t user_sp_save;   /* +8:  è‡¨æ™‚ä¿å­˜ User SP */
    uint64_t user_tp_save;   /* +16: ä¿å­˜ User TP */

    /* â”€â”€â”€ Standard SMP Data â”€â”€â”€ */
    uint64_t hartid;         /* +24: ç¡¬é«”åŸ·è¡Œç·’ ID */
    tcb_t   *current_task;   /* ç•¶å‰åŸ·è¡Œçš„ Task */
    tcb_t   *idle_task;      /* é€™å€‹æ ¸å¿ƒçš„ Idle Task */
    uint32_t irq_nesting;    /* ä¸­æ–·å·¢ç‹€è¨ˆæ•¸ */
    uint32_t need_reschedule;/* éœ€è¦é‡æ–°æ’ç¨‹çš„æ——æ¨™ */
} __attribute__((aligned(64))) cpu_t;
```

**æ³¨æ„**ï¼šå‰ä¸‰å€‹æ¬„ä½çš„é †åºå’Œ offset æ˜¯å›ºå®šçš„ï¼Œå› ç‚ºçµ„åˆèªè¨€æœƒç›´æ¥ç”¨æ•¸å­— offset å­˜å–ï¼

### 3.4 å®Œæ•´çš„ Trap Entry æµç¨‹

ç¾åœ¨è®“æˆ‘å€‘çœ‹çœ‹å®Œæ•´çš„ trap_entryï¼š

```asm
trap_entry:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Step 1: èº«ä»½åˆ‡æ› - å¾ User ä¸–ç•Œé€²å…¥ Kernel ä¸–ç•Œ
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    csrrw   tp, mscratch, tp    # tp = &cpu_t, mscratch = user_tp

    # å¦‚æœ tp = 0ï¼Œè¡¨ç¤ºæˆ‘å€‘æœ¬ä¾†å°±åœ¨ M-modeï¼ˆkernel taskï¼‰
    beqz    tp, .from_m_mode

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Step 2: åˆ‡æ›åˆ° Kernel Stack
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    sd      sp, 8(tp)           # ä¿å­˜ user_sp åˆ° cpu_t.user_sp_save
    ld      sp, 0(tp)           # è¼‰å…¥ kernel_sp from cpu_t.kernel_trap_sp

    # ç¾åœ¨æˆ‘å€‘æœ‰äº†å®‰å…¨çš„ Kernel Stackï¼
    addi    sp, sp, -CONTEXT_SIZE   # åˆ†é… context frame

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Step 3: ä¿å­˜æ‰€æœ‰æš«å­˜å™¨
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    sd      t0, REG_T0(sp)
    ld      t0, 8(tp)           # å–å› user_sp
    sd      t0, REG_SP(sp)      # ä¿å­˜ user_sp
    csrr    t0, mscratch
    sd      t0, REG_TP(sp)      # ä¿å­˜ user_tp
    # ... ä¿å­˜å…¶é¤˜æš«å­˜å™¨ ...
    j       .save_context

.from_m_mode:
    # æœ¬ä¾†å°±åœ¨ M-modeï¼Œæ¢å¾© tp ä¸¦ç”¨å‚³çµ±æ–¹å¼è™•ç†
    csrrw   tp, mscratch, tp    # æ¢å¾© tp = &cpu_t
    # ... v2 é¢¨æ ¼çš„ M-mode trap handling ...
```

---

## å››ã€è¡€æ·šæ•™è¨“ï¼štrap_exit çš„åˆ†æ­§

åœ¨ v3.x é–‹ç™¼éç¨‹ä¸­ï¼Œæˆ‘å€‘é‡åˆ°äº†ä¸€å€‹è®“äººæŠ“ç‹‚çš„ bugã€‚é€™å€‹ bug èŠ±äº†æˆ‘æ•´æ•´ä¸€å€‹ä¸‹åˆæ‰æ‰¾åˆ°ï¼Œå€¼å¾—å¥½å¥½è¨˜éŒ„ã€‚

### 4.1 å•é¡Œç¾è±¡

danieRTOS v3.x æ”¯æ´å…©ç¨®é¡å‹çš„ä»»å‹™ï¼š

- **U-mode Task**ï¼šæ™®é€šä½¿ç”¨è€…ä»»å‹™ï¼Œé‹è¡Œåœ¨ User Mode
- **M-mode Task**ï¼šKernel ä»»å‹™ï¼ˆå¦‚ Monitorï¼‰ï¼Œé‹è¡Œåœ¨ Machine Mode

æˆ‘è¨­è¨ˆäº†ä¸€å€‹ Monitor taskï¼Œç”¨ä¾†ç›£æ§ç³»çµ±ç‹€æ…‹ã€‚å®ƒè¢«å›ºå®šåœ¨ Core 1 ä¸ŠåŸ·è¡Œï¼Œæ¯éš”ä¸€æ®µæ™‚é–“è¼¸å‡ºä¸€äº›è³‡è¨Šã€‚

**ç—‡ç‹€**ï¼šç³»çµ±å•Ÿå‹•å¾Œï¼ŒMonitor task è¼¸å‡ºäº†ä¸€è¡Œè¨Šæ¯å°±å´©æ½°äº†ã€‚

```
[Monitor] Kernel monitor started in M-mode
<crash>
```

### 4.2 é™¤éŒ¯éç¨‹

æˆ‘ç”¨ GDB è¿½è¹¤ï¼Œç™¼ç¾ Monitor task ç¬¬ä¸€æ¬¡è¢« Timer ä¸­æ–·å¾Œï¼Œé‡æ–°åŸ·è¡Œæ™‚ `tp = 0`ã€‚

**ç­‰ç­‰ï¼Œtp æ‡‰è©²æ˜¯ &cpu_t æ‰å°ï¼**

å›é ­çœ‹ trap_exit çš„ç¨‹å¼ç¢¼ï¼Œæˆ‘ç™¼ç¾äº†å•é¡Œï¼š

```asm
# éŒ¯èª¤çš„ trap_exitï¼ˆå°æ‰€æœ‰ä»»å‹™éƒ½åŸ·è¡Œ tp æ¢å¾©ï¼‰
trap_exit:
    ld t0, REG_TP(sp)      # t0 = 0 (M-mode task æ²’æœ‰ User TLS!)
    csrw mscratch, tp      # mscratch = &cpu_t
    csrw mscratch, t0      # mscratch = 0 â† å•é¡Œï¼

    # ... æ¢å¾©æš«å­˜å™¨ ...
    ld tp, REG_TP(sp)      # tp = 0 â† ç½é›£ï¼
    mret
```

**æ ¹å› **ï¼šM-mode task çš„ context ä¸­ï¼Œtp æ¬„ä½è¢«åˆå§‹åŒ–ç‚º 0ï¼ˆå› ç‚ºå®ƒä¸éœ€è¦ User TLSï¼‰ã€‚ä½† trap_exit ç„¡è…¦åœ°æŠŠé€™å€‹ 0 æ¢å¾©åˆ° tpï¼Œè¦†è“‹æ‰äº†æ­£ç¢ºçš„ `&cpu_t`ã€‚

### 4.3 è§£æ±ºæ–¹æ¡ˆï¼šæ ¹æ“š MPP ä½åˆ†æ­§è™•ç†

è§£æ±ºæ–¹æ¡ˆå¾ˆå„ªé›…ï¼š**æª¢æŸ¥ mstatus.MPP ä½ï¼Œæ±ºå®šè¿”å›çš„æ˜¯ U-mode é‚„æ˜¯ M-mode**ã€‚

```asm
trap_exit:
    # æ¢å¾© mstatus
    ld      t0, REG_MSTATUS(sp)
    csrw    mstatus, t0

    # â”€â”€â”€ æª¢æŸ¥å°‡è¿”å›çš„ç‰¹æ¬Šç´š â”€â”€â”€
    # MPP æ˜¯ mstatus çš„ bit 12:11
    # MPP = 0 è¡¨ç¤º U-mode, MPP = 3 è¡¨ç¤º M-mode
    srli    t1, t0, 11
    andi    t1, t1, 3
    bnez    t1, .restore_m_mode

.restore_u_mode:
    # â”€â”€â”€ è¿”å› U-modeï¼šæ¢å¾© User tpï¼Œè¨­ç½® mscratch â”€â”€â”€
    csrw    mscratch, tp         # mscratch = &cpu_t
    ld      tp, REG_TP(sp)       # tp = user_tp
    # ... æ¢å¾©å…¶é¤˜æš«å­˜å™¨ ...
    ld      sp, REG_SP(sp)
    mret

.restore_m_mode:
    # â”€â”€â”€ è¿”å› M-modeï¼šä¿æŒ tp = &cpu_t â”€â”€â”€
    csrw    mscratch, zero       # mscratch = 0 (M-mode æ¨™è¨˜)
    # æ³¨æ„ï¼šä¸æ¢å¾© tpï¼
    # ... æ¢å¾©å…¶é¤˜æš«å­˜å™¨ ...
    ld      sp, REG_SP(sp)
    mret
```

**é€™å€‹ç¶“é©—æ•™æœƒæˆ‘ä¸€ä»¶äº‹**ï¼šç•¶æ•´åˆå…©å€‹ä¸åŒè¨­è¨ˆçš„ç³»çµ±æ™‚ï¼Œã€Œé‚Šç•Œæ¢ä»¶ã€å¾€å¾€æ˜¯ bug çš„æº«åºŠã€‚

---

## äº”ã€v3.x ç³»çµ±æ¶æ§‹

ç¶“é v3p0 å’Œ v3p1 çš„é–‹ç™¼ï¼Œç¾åœ¨ danieRTOS v3.x çš„æ¶æ§‹å·²ç¶“æˆå½¢ï¼š

### 5.1 æ¶æ§‹ç¸½è¦½

```
            Core 0                         Core 1
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ User Task A (U-mode)â”‚        â”‚ Monitor (M-mode)    â”‚
    â”‚ User Task B (U-mode)â”‚        â”‚ User Task C (U-mode)â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚    Kernel (M-mode)  â”‚        â”‚    Kernel (M-mode)  â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  cpu_t (tp)   â”‚  â”‚        â”‚  â”‚  cpu_t (tp)   â”‚  â”‚
    â”‚  â”‚ kernel_trap_spâ”‚  â”‚        â”‚  â”‚ kernel_trap_spâ”‚  â”‚
    â”‚  â”‚ current_task  â”‚  â”‚        â”‚  â”‚ current_task  â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                              â”‚
              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€ IPI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
              â”‚                              â”‚
              â–¼                              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚            Shared Kernel Data (Spinlock)           â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”     â”‚
    â”‚  â”‚Ready Listâ”‚ â”‚Semaphoresâ”‚ â”‚ Mutex â”‚ â”‚ Queue â”‚     â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 è¨˜æ†¶é«”ä½ˆå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Memory Layout (v3.x)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x80000000 - 0x8001FFFF â”‚ Kernel Code & Data (128 KB)       â”‚
â”‚                         â”‚ PMP: M:RWX, U:None                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x80020000 - 0x8003FFFF â”‚ User Code & Data (128 KB)         â”‚
â”‚                         â”‚ PMP: M:RW, U:RWX (Static)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x80040000+             â”‚ Task Stacks (Kernel + User)        â”‚
â”‚                         â”‚ Per-Task åˆ†é…                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 v3.x ç‰ˆæœ¬è¦åŠƒ

| ç‰ˆæœ¬ | ä»£è™Ÿ | ç›®æ¨™ | ç‹€æ…‹ |
|------|------|------|------|
| **v3p0** | åŸºç¤æ•´åˆ | M-mode kernel tasks åœ¨ SMP ä¸Šé‹è¡Œ | âœ… å®Œæˆ |
| **v3p1** | æ··åˆæ¨¡å¼ | M-mode + U-mode tasks åŒæ™‚é‹è¡Œ | âœ… å®Œæˆ |
| **v3p2** | å®Œæ•´åŠŸèƒ½ | PMP ä¿è­·ã€å®Œæ•´ syscallsã€Fault Isolation | ğŸ”œ è¨ˆç•«ä¸­ |

---

## å…­ã€Demoï¼šæ··åˆä»»å‹™é‹è¡Œ

è®“æˆ‘å€‘çœ‹ä¸€å€‹ v3.x çš„ demoï¼Œå±•ç¤º M-mode å’Œ U-mode ä»»å‹™åŒæ™‚é‹è¡Œï¼š

### 6.1 Demo ç¨‹å¼ç¢¼

```c
/* demo_usermode.c */

/* U-mode ä»»å‹™ï¼šåªèƒ½é€é syscall åš I/O */
static void user_task_a(void *arg) {
    sys_puts("[UserTaskA] Started in U-mode!\n");
    for (int i = 0; i < 10; i++) {
        sys_putchar('A');
        sys_delay(50);
    }
    sys_puts("\n[UserTaskA] Done!\n");
    sys_exit();
}

/* M-mode ä»»å‹™ï¼šå¯ä»¥ç›´æ¥å­˜å–ç¡¬é«” */
static void monitor_task(void *arg) {
    uart_puts("[Monitor] Kernel monitor started in M-mode\n");
    for (int i = 0; i < 5; i++) {
        uart_printf("[Monitor] Loop %d, tick=%d\n", i, tick_get());
        task_delay(100);
    }
    uart_puts("[Monitor] Done!\n");
}

void demo_init(void) {
    uart_puts("\n=== danieRTOS v3.x User Mode Demo ===\n");

    /* M-mode kernel task, å›ºå®šåœ¨ Core 1 */
    task_create("Monitor", monitor_task, NULL, 3,
                monitor_stack, sizeof(monitor_stack), (1U << 1));

    /* U-mode user tasks, å¯ä»¥åœ¨ä»»æ„ Core */
    task_create_user("UserA", user_task_a, NULL, 2, CONFIG_CORE_ANY);
    task_create_user("UserB", user_task_b, NULL, 2, CONFIG_CORE_ANY);
}
```

### 6.2 é‹è¡Œçµæœ

```
=== danieRTOS v3.x User Mode Demo ===
Number of cores: 2
Creating Monitor task (M-mode, Core 1)...
Creating User tasks (U-mode)...
All tasks created. Starting scheduler...
[Monitor] Kernel monitor started in M-mode
[UserTaskA] Started in U-mode!
[UserTaskB] Started in U-mode!
A0 B0 A1 B1 [Monitor] Loop 0, tick=100
A2 B2 A3 B3 [Monitor] Loop 1, tick=200
A4 B4 A5 B5 [Monitor] Loop 2, tick=300
...
```

**è§€å¯Ÿé‡é»**ï¼š
- Monitor åœ¨ Core 1 ç©©å®šåŸ·è¡Œï¼ˆM-modeï¼‰
- UserA/B åœ¨ Core 0 è¼ªæµåŸ·è¡Œï¼ˆU-modeï¼‰
- è¼¸å‡ºäº¤éŒ¯ä½†ç³»çµ±ç©©å®š

---

## ä¸ƒã€æœ¬ç« ç¸½çµ

SMP + User Mode æ•´åˆçš„æ ¸å¿ƒæŒ‘æˆ°èˆ‡è§£æ±ºæ–¹æ¡ˆï¼š

| æŒ‘æˆ° | è§£æ±ºæ–¹æ¡ˆ | é—œéµç¨‹å¼ç¢¼ |
|------|----------|------------|
| tp çš„é›™é‡è§’è‰² | mscratch ä½œç‚ºæ©‹æ¨‘ | `csrrw tp, mscratch, tp` |
| Trap Entry æ™‚æ‰¾ä¸åˆ° cpu_t | å¾ mscratch äº¤æ› | trap_entry ç¬¬ä¸€è¡Œ |
| M-mode vs U-mode è¿”å›è·¯å¾‘ | æª¢æŸ¥ MPP ä½åˆ†æ­§è™•ç† | trap_exit æ¢ä»¶åˆ¤æ–· |
| Per-Task Kernel Stack | cpu_t.kernel_trap_sp | Context Switch æ™‚æ›´æ–° |

### å¾ŒçºŒç« ç¯€é å‘Š

| ç« ç¯€ | æ¨™é¡Œ | ä¸»é¡Œ |
|------|------|------|
| Ch 32 | éˆé­‚äº¤æ› | tp/mscratch å®Œæ•´å¯¦ä½œç´°ç¯€ |
| Ch 33 | é›™é‡ä¿éšª | Per-Task Kernel Stack è¨­è¨ˆ |
| Ch 34 | å‹•æ…‹é‚Šç•Œ | SMP ä¸‹çš„ PMP é…ç½® |
| Ch 35 | å¤šæ ¸ Syscall | Syscall + Fine-grained Locking |

æº–å‚™å¥½äº†å—ï¼Ÿè®“æˆ‘å€‘ç¹¼çºŒé€™è¶Ÿ SMP + User Mode çš„æ—…ç¨‹ï¼

---

## åƒè€ƒè³‡æ–™

**RISC-V è¦æ ¼**

- [RISC-V Privileged Specification](https://riscv.org/specifications/privileged-isa/)
  M-modeã€CSRã€Trap æ©Ÿåˆ¶çš„å®˜æ–¹è¦æ ¼ã€‚

**danieRTOS ç³»åˆ—**

- danieRTOS v1.x (User Mode): Ch 13-19
- danieRTOS v2.x (SMP): Ch 20-30

**å»¶ä¼¸é–±è®€**

- See RISC-V Run: Ch 04 (Privilege Modes), Ch 10 (Multi-core)
- FreeRTOS SMP: Multi-Core Support

---

## ç‰ˆæ¬Šè²æ˜

æœ¬æ–‡æ¡ç”¨ [CC BY 4.0](https://creativecommons.org/licenses/by/4.0/) æˆæ¬Šã€‚

**å‡ºè™•**: [tech-column-public](https://github.com/djiangtw/tech-column-public)

